<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #0f172a; color: #e2e8f0; font-family: 'Inter', system-ui, sans-serif; }
    .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.5); }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-4xl mx-auto px-6 py-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-white">âš¡ test</h1>
      <p class="text-sm text-gray-400 mt-1">Generated by Garuda GLang Pipeline</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Input Panel -->
      <div class="glass rounded-xl p-6">
        <h2 class="text-lg font-semibold text-cyan-400 mb-4">ðŸ“¥ Inputs</h2>
        <form id="pipeline-form" onsubmit="return runPipeline(event)">
          
          <button type="submit" id="run-btn"
                  class="w-full py-2.5 px-4 bg-cyan-600 hover:bg-cyan-500 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
            <span id="run-icon">â–¶</span>
            <span id="run-text">Run Pipeline</span>
          </button>
        </form>
      </div>

      <!-- Output Panel -->
      <div class="glass rounded-xl p-6">
        <h2 class="text-lg font-semibold text-orange-400 mb-4">ðŸ“¤ Outputs</h2>
        <div id="output-panel">
          <p class="text-gray-500 text-sm">No output components defined</p>
        </div>
        <div id="execution-log" class="mt-4 hidden">
          <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">Execution Log</h3>
          <pre id="exec-log" class="p-3 bg-gray-900 rounded-lg text-xs text-gray-400 font-mono overflow-auto max-h-40"></pre>
        </div>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="mt-6 flex items-center gap-4 text-xs text-gray-500">
      <span id="status-text">Ready</span>
      <span id="elapsed-text"></span>
      <div class="flex-1"></div>
      <span>Powered by Garuda GLang</span>
    </div>
  </div>

  <script>
    const GARUDA_URL = '';
    let SESSION_ID = null;

    // Initialize session on load
    async function initSession() {
      try {
        const res = await fetch('/api/proxy/session', { method: 'POST' });
        const data = await res.json();
        SESSION_ID = data.session_id;
        document.getElementById('status-text').textContent = 'Session ready: ' + SESSION_ID;
      } catch (e) {
        document.getElementById('status-text').textContent = 'Error: Cannot connect to Garuda';
        console.error('Failed to init session:', e);
      }
    }

    async function runPipeline(event) {
      event.preventDefault();
      if (!SESSION_ID) {
        alert('No Garuda session. Is the Garuda IDE running?');
        return false;
      }

      const btn = document.getElementById('run-btn');
      const icon = document.getElementById('run-icon');
      const text = document.getElementById('run-text');
      const statusEl = document.getElementById('status-text');
      const elapsedEl = document.getElementById('elapsed-text');
      const logEl = document.getElementById('exec-log');
      const logContainer = document.getElementById('execution-log');

      btn.disabled = true;
      icon.textContent = 'â³';
      text.textContent = 'Running...';
      statusEl.textContent = 'Executing pipeline...';
      logContainer.classList.remove('hidden');
      logEl.textContent = '';

      const startTime = Date.now();

      try {
        // Collect form inputs
        const form = document.getElementById('pipeline-form');
        const formData = new FormData(form);
        const inputs = {};
        for (const [key, value] of formData.entries()) {
          inputs[key] = value;
        }

        // Set input variables in Garuda session
        for (const [name, value] of Object.entries(inputs)) {
          const setCmd = 'set input_' + name + ' ' + JSON.stringify(value);
          await executeCommand(setCmd);
          logEl.textContent += '> ' + setCmd + '\n';
        }

        // Execute the GLang script line by line
        const script = "component input string username --label \"Username\" --default \"Alice\" --required\nset summary = f\"User: {$input_username}, Age: {$input_age}, Role: {$input_role}\"\necho $summary\ncomponent output text result --label \"Summary\"\ncomponent input number age --label \"Age\" --min 0 --max 150 --default 25\ncomponent input dropdown role --label \"Role\" --options \"admin,editor,viewer\" --default \"editor\"";
        const lines = script.split('\n').filter(l => l.trim());
        for (const line of lines) {
          logEl.textContent += '> ' + line + '\n';
          const result = await executeCommand(line);
          if (result.stdout) logEl.textContent += result.stdout + '\n';
          if (result.error) logEl.textContent += 'ERROR: ' + result.error + '\n';
        }

        // Read output variables
        // No output components

        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        statusEl.textContent = 'Completed successfully';
        elapsedEl.textContent = elapsed + 's';
      } catch (e) {
        statusEl.textContent = 'Error: ' + e.message;
        logEl.textContent += 'FATAL: ' + e.message + '\n';
      } finally {
        btn.disabled = false;
        icon.textContent = 'â–¶';
        text.textContent = 'Run Pipeline';
      }

      return false;
    }

    async function executeCommand(cmd) {
      const res = await fetch('/api/proxy/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: SESSION_ID, command: cmd })
      });
      return await res.json();
    }

    async function getVariable(name) {
      const res = await fetch('/api/proxy/variables/' + SESSION_ID);
      const data = await res.json();
      return (data.variables || {})[name];
    }

    // Output renderers
    function renderTextOutput(elemId, value) {
      const el = document.getElementById(elemId);
      if (el) el.textContent = typeof value === 'string' ? value : JSON.stringify(value, null, 2);
    }

    function renderJsonOutput(elemId, value) {
      const el = document.getElementById(elemId);
      if (el) el.textContent = JSON.stringify(value, null, 2);
    }

    function renderTableOutput(elemId, value) {
      const thead = document.getElementById(elemId + '-thead');
      const tbody = document.getElementById(elemId + '-tbody');
      if (!thead || !tbody || !Array.isArray(value) || !value.length) return;
      const keys = Object.keys(value[0]);
      thead.innerHTML = keys.map(k => '<th class="px-3 py-2 text-left text-gray-400">' + k + '</th>').join('');
      tbody.innerHTML = value.map(row =>
        '<tr class="border-t border-gray-700">' +
        keys.map(k => '<td class="px-3 py-2">' + (row[k] ?? '') + '</td>').join('') +
        '</tr>'
      ).join('');
    }

    function renderHtmlOutput(elemId, value) {
      const el = document.getElementById(elemId);
      if (el) el.innerHTML = value;
    }

    function renderMediaOutput(elemId, value) {
      const el = document.getElementById(elemId);
      if (!el) return;
      if (typeof value === 'string' && (value.match(/\.(png|jpg|jpeg|gif|svg|webp)$/i))) {
        el.innerHTML = '<img src="' + value + '" class="max-w-full rounded">';
      } else {
        el.textContent = JSON.stringify(value);
      }
    }

    function renderLogOutput(elemId, value) {
      const el = document.getElementById(elemId);
      if (el) el.textContent += (typeof value === 'string' ? value : JSON.stringify(value)) + '\n';
    }

    function renderMarkdownOutput(elemId, value) {
      const el = document.getElementById(elemId);
      if (el) el.innerHTML = typeof value === 'string' ? value.replace(/\n/g, '<br>') : JSON.stringify(value);
    }

    // Init on load
    initSession();
  </script>
</body>
</html>